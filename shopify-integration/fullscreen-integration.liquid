<!-- Shopify Integration for Fullscreen 3D Configurator -->
<!-- Add this to your product page template (product.liquid) -->

<!-- 1. Replace your existing "Add to Cart" section with this -->
<div class="product-form">
  <!-- Standard Shopify product form (hidden, will be controlled by configurator) -->
  <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form-{{ product.id }}" style="display: none;">
    <select name="id" id="product-select-{{ product.id }}">
      {% for variant in product.variants %}
        <option 
          value="{{ variant.id }}"
          data-color="{{ variant.option1 | downcase }}"
          data-price="{{ variant.price | money_without_currency }}"
          {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %}>
          {{ variant.title }} - {{ variant.price | money }}
        </option>
      {% endfor %}
    </select>
    <input type="number" name="quantity" value="1" min="1" />
  </form>

  <!-- 3D Configurator Button -->
  <div class="configurator-section">
    <button onclick="open3DConfigurator()" class="configurator-btn">
      ðŸŽ¨ Customize in 3D
    </button>
    <p class="configurator-description">
      Design your perfect sofa with our interactive 3D configurator
    </p>
  </div>

  <!-- Standard Add to Cart (fallback) -->
  <div class="standard-cart-section" style="margin-top: 15px;">
    <button 
      type="submit" 
      form="product-form-{{ product.id }}"
      class="btn product-form__cart-submit"
      id="standard-add-to-cart">
      <span>Add to cart - <span id="current-price">{{ product.price | money }}</span></span>
    </button>
  </div>
</div>

<!-- 2. Hidden 3D Configurator Container -->
<div id="configurator-container" class="configurator-fullscreen" style="display: none;">
  <iframe
    id="configurator-iframe"
    src=""
    style="width: 100%; height: 100%; border: none;"
    allow="fullscreen; camera; microphone"
  ></iframe>
</div>

<style>
/* Configurator Integration Styles */
.configurator-section {
  margin: 20px 0;
}

.configurator-btn {
  background: linear-gradient(135deg, #ff6b35, #f7931e);
  color: white;
  border: none;
  padding: 18px 32px;
  border-radius: 8px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
  width: 100%;
  max-width: 400px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.configurator-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
}

.configurator-description {
  color: #666;
  font-size: 14px;
  margin: 12px 0 0 0;
  text-align: center;
  max-width: 400px;
}

.configurator-fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: white;
}

/* Success notification */
.configurator-success {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  z-index: 10000;
  font-weight: 600;
  animation: slideInNotification 0.3s ease-out;
}

@keyframes slideInNotification {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Mobile responsive */
@media (max-width: 768px) {
  .configurator-btn {
    font-size: 16px;
    padding: 16px 24px;
  }
  
  .configurator-success {
    right: 10px;
    left: 10px;
  }
}
</style>

<script>
// 3D Configurator Integration Script for Shopify
(function() {
  'use strict';
  
  let configuratorOpen = false;
  const productId = {{ product.id }};
  
  // Configuration
  const CONFIG = {
    configuratorUrl: 'https://iani-configurator.vercel.app', // Your deployed URL
    // configuratorUrl: 'http://localhost:5173', // For testing locally
    clientId: 'ianii'
  };
  
  // Open 3D Configurator
  window.open3DConfigurator = function() {
    console.log('ðŸŽ¨ Opening 3D Configurator for product:', productId);
    
    if (configuratorOpen) return;
    
    const container = document.getElementById('configurator-container');
    const iframe = document.getElementById('configurator-iframe');
    
    if (!container || !iframe) {
      console.error('âŒ Configurator elements not found');
      return;
    }
    
    // Build URL with product data
    const configuratorUrl = buildConfiguratorUrl();
    
    // Load configurator
    iframe.src = configuratorUrl;
    container.style.display = 'block';
    document.body.style.overflow = 'hidden';
    configuratorOpen = true;
    
    // Listen for messages from configurator
    window.addEventListener('message', handleConfiguratorMessage);
    
    console.log('ðŸš€ Configurator opened:', configuratorUrl);
  };
  
  // Close configurator
  function closeConfigurator() {
    console.log('âŒ Closing configurator');
    
    const container = document.getElementById('configurator-container');
    const iframe = document.getElementById('configurator-iframe');
    
    if (container) container.style.display = 'none';
    if (iframe) iframe.src = '';
    
    document.body.style.overflow = '';
    configuratorOpen = false;
    
    window.removeEventListener('message', handleConfiguratorMessage);
  }
  
  // Build configurator URL with product data
  function buildConfiguratorUrl() {
    const variants = getProductVariants();
    
    const params = new URLSearchParams({
      embedded: 'true',
      client: CONFIG.clientId,
      productId: productId,
      shopifyIntegration: 'true',
      variants: JSON.stringify(variants)
    });
    
    return `${CONFIG.configuratorUrl}?${params.toString()}`;
  }
  
  // Get product variants data
  function getProductVariants() {
    const variants = [];
    const selectElement = document.getElementById('product-select-' + productId);
    
    if (selectElement) {
      Array.from(selectElement.options).forEach(option => {
        variants.push({
          id: option.value,
          color: option.dataset.color,
          price: parseFloat(option.dataset.price),
          title: option.text
        });
      });
    }
    
    return variants;
  }
  
  // Handle messages from configurator iframe
  function handleConfiguratorMessage(event) {
    // Security check
    const allowedOrigins = [
      'https://iani-configurator.vercel.app',
      'http://localhost:5173'
    ];
    
    if (!allowedOrigins.some(origin => event.origin === origin)) {
      console.warn('ðŸš« Unauthorized message origin:', event.origin);
      return;
    }
    
    const { type, data } = event.data;
    console.log('ðŸ“¨ Message from configurator:', type, data);
    
    switch (type) {
      case 'CONFIGURATOR_READY':
        console.log('âœ… Configurator ready');
        break;
        
      case 'CONFIGURATOR_ADD_TO_CART':
        handleAddToCart(data);
        break;
        
      case 'CONFIGURATOR_CLOSE':
        closeConfigurator();
        break;
        
      default:
        console.log('ðŸ”„ Unknown message type:', type);
    }
  }
  
  // Handle add to cart from configurator
  async function handleAddToCart(configData) {
    console.log('ðŸ›’ Adding configured product to cart:', configData);
    
    try {
      // Find the matching variant
      const variantId = findVariantByColor(configData.color);
      
      if (!variantId) {
        throw new Error(`No variant found for color: ${configData.color}`);
      }
      
      // Add to Shopify cart
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: configData.quantity || 1,
          properties: {
            'Configuration': JSON.stringify(configData.configuration),
            'Color': configData.colorLabel,
            'Configured in 3D': 'Yes'
          }
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('âœ… Added to cart successfully:', result);
        
        // Close configurator
        closeConfigurator();
        
        // Show success message
        showSuccessMessage(`âœ… ${configData.colorLabel} sofa added to cart!`);
        
        // Update cart UI (if you have cart drawer/count)
        updateCartUI();
        
        // Optional: Open cart drawer
        // if (window.theme && window.theme.openCartDrawer) {
        //   window.theme.openCartDrawer();
        // }
        
      } else {
        throw new Error('Failed to add to cart');
      }
      
    } catch (error) {
      console.error('âŒ Error adding to cart:', error);
      showSuccessMessage('âŒ Failed to add to cart. Please try again.', 'error');
    }
  }
  
  // Find variant ID by color
  function findVariantByColor(color) {
    const selectElement = document.getElementById('product-select-' + productId);
    if (!selectElement) return null;
    
    const option = Array.from(selectElement.options).find(opt => 
      opt.dataset.color === color.toLowerCase()
    );
    
    return option ? option.value : null;
  }
  
  // Update cart UI elements
  function updateCartUI() {
    // Update cart count if you have one
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartCount = document.querySelector('.cart-count, [data-cart-count]');
        if (cartCount) {
          cartCount.textContent = cart.item_count;
        }
        
        console.log('ðŸ›’ Cart updated:', cart.item_count, 'items');
      })
      .catch(err => console.warn('Could not update cart UI:', err));
  }
  
  // Show success/error message
  function showSuccessMessage(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `configurator-${type}`;
    notification.textContent = message;
    
    if (type === 'error') {
      notification.style.background = '#dc3545';
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          notification.parentNode.removeChild(notification);
        }, 300);
      }
    }, 5000);
  }
  
  // Handle escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && configuratorOpen) {
      closeConfigurator();
    }
  });
  
  console.log('ðŸš€ 3D Configurator integration loaded for product:', productId);
  
})();
</script>

<!-- 
SETUP INSTRUCTIONS:

1. **Replace your existing product form** with the code above
2. **Update CONFIG.configuratorUrl** to your deployed URL
3. **Make sure your product variants have color options** as option1
4. **Test the integration**:
   - Click "Customize in 3D" â†’ Opens configurator
   - Configure your product â†’ Click "Add to Cart"
   - Product should be added to Shopify cart with configuration data

5. **Optional enhancements**:
   - Integrate with your cart drawer
   - Add loading states
   - Customize success messages
   - Add analytics tracking

The configurator will now work as a fullscreen overlay and the "Add to Cart" button inside it will actually add the product to your Shopify cart!
-->
