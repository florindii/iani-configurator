<!-- SECTIONS-BASED THEME INTEGRATION -->
<!-- Add this to your sections/main-product.liquid file -->

<!-- Add after the existing product form, around line 110-120 -->

{% comment %} 3D CONFIGURATOR INTEGRATION START {% endcomment %}
{% if product.metafields.custom.enable_3d_configurator == 'true' %}

<!-- 3D Configurator Section -->
<div class="configurator-integration" style="margin: 20px 0;">
  <div class="configurator-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; text-align: center; color: white; margin-bottom: 20px;">
    <div style="font-size: 48px; margin-bottom: 16px;">üõãÔ∏è</div>
    <h3 style="font-size: 24px; margin-bottom: 12px; font-weight: 700;">Interactive 3D Configurator</h3>
    <p style="font-size: 16px; margin-bottom: 24px; opacity: 0.9;">Customize colors and see your sofa in real-time 3D</p>
    <button onclick="open3DConfigurator()" class="btn btn-primary" style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; border: none; padding: 16px 32px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease;">
      üé® Launch 3D Configurator
    </button>
  </div>
  
  <!-- Configuration Summary -->
  <div id="config-summary" class="config-summary" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #e9ecef; margin-top: 15px;">
    <h4 style="margin-bottom: 12px; color: #495057;">Your Configuration:</h4>
    <div class="config-details" style="display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap;">
      <span class="config-color">Color: <strong id="selected-color">Blue</strong></span>
      <span class="config-price">Price: <strong id="selected-price">${{ product.price | divided_by: 100.0 }}</strong></span>
    </div>
    <button onclick="open3DConfigurator()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; margin-top: 12px; cursor: pointer;">
      ‚úèÔ∏è Edit Configuration
    </button>
  </div>
</div>

<!-- Hidden form for cart integration -->
<form action="/cart/add" method="post" id="configurator-cart-form-{{ product.id }}" style="display: none;">
  <select name="id" id="configurator-variant-select-{{ product.id }}">
    {% for variant in product.variants %}
      <option 
        value="{{ variant.id }}"
        data-color="{{ variant.option1 | downcase }}"
        data-price="{{ variant.price | divided_by: 100.0 }}">
        {{ variant.title }}
      </option>
    {% endfor %}
  </select>
  <input type="number" name="quantity" value="1" />
  <input type="hidden" name="properties[Configuration]" id="config-data-{{ product.id }}" />
  <input type="hidden" name="properties[Color]" id="config-color-{{ product.id }}" />
  <input type="hidden" name="properties[Configured in 3D]" value="Yes" />
</form>

{% endif %}
{% comment %} 3D CONFIGURATOR INTEGRATION END {% endcomment %}

<!-- 3D Configurator Modal -->
<div id="configurator-container" class="configurator-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease;">
  <div class="configurator-backdrop" onclick="closeConfigurator()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8);"></div>
  <div class="configurator-content" style="position: relative; width: 95vw; height: 95vh; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transform: scale(0.9); transition: transform 0.3s ease;">
    <button class="configurator-close" onclick="closeConfigurator()" style="position: absolute; top: 16px; right: 16px; width: 44px; height: 44px; border: none; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 50%; font-size: 28px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;">√ó</button>
    <iframe id="configurator-iframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
  </div>
</div>

<script>
// 3D Configurator Integration Script
(function() {
  'use strict';
  
  let configuratorOpen = false;
  const productId = {{ product.id }};
  
  // Configuration - UPDATE THIS URL TO YOUR DEPLOYED VERCEL APP
  const CONFIG = {
    configuratorUrl: 'https://iani-configurator.vercel.app', // ‚ö†Ô∏è CHANGE THIS
    clientId: 'ianii',
    productId: productId
  };
  
  // Product variants
  const variants = [
    {% for variant in product.variants %}
      {
        id: '{{ variant.id }}',
        color: '{{ variant.option1 | downcase }}',
        price: {{ variant.price | divided_by: 100.0 }},
        title: '{{ variant.title }}'
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  
  // Open configurator
  window.open3DConfigurator = function() {
    console.log('üé® Opening configurator...');
    
    const container = document.getElementById('configurator-container');
    const iframe = document.getElementById('configurator-iframe');
    
    if (!container || !iframe) {
      alert('Configurator failed to load');
      return;
    }
    
    // Build URL
    const params = new URLSearchParams({
      embedded: 'true',
      client: CONFIG.clientId,
      productId: CONFIG.productId,
      variants: JSON.stringify(variants)
    });
    
    iframe.src = CONFIG.configuratorUrl + '?' + params.toString();
    container.style.display = 'flex';
    container.style.opacity = '1';
    container.style.visibility = 'visible';
    container.querySelector('.configurator-content').style.transform = 'scale(1)';
    document.body.style.overflow = 'hidden';
    configuratorOpen = true;
    
    window.addEventListener('message', handleConfiguratorMessage);
  };
  
  // Close configurator
  window.closeConfigurator = function() {
    const container = document.getElementById('configurator-container');
    
    if (container) {
      container.style.opacity = '0';
      container.style.visibility = 'hidden';
      container.querySelector('.configurator-content').style.transform = 'scale(0.9)';
      setTimeout(() => {
        container.style.display = 'none';
        document.getElementById('configurator-iframe').src = '';
      }, 300);
    }
    
    document.body.style.overflow = '';
    configuratorOpen = false;
    window.removeEventListener('message', handleConfiguratorMessage);
  };
  
  // Handle messages from configurator
  function handleConfiguratorMessage(event) {
    if (!event.origin.includes('vercel.app') && !event.origin.includes('localhost')) return;
    
    const { type, data } = event.data || {};
    console.log('üì® Configurator message:', type, data);
    
    if (type === 'CONFIGURATOR_ADD_TO_CART') {
      handleAddToCart(data);
    } else if (type === 'CONFIGURATOR_CLOSE') {
      closeConfigurator();
    }
  }
  
  // Handle add to cart
  async function handleAddToCart(configData) {
    console.log('üõí Adding to cart:', configData);
    
    try {
      const variant = variants.find(v => v.color === configData.color.toLowerCase());
      
      if (!variant) {
        throw new Error('Variant not found for color: ' + configData.color);
      }
      
      // Add to cart via Shopify API
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: variant.id,
          quantity: 1,
          properties: {
            'Configuration': JSON.stringify(configData.configuration),
            'Color': configData.colorLabel,
            'Configured in 3D': 'Yes'
          }
        })
      });
      
      if (response.ok) {
        closeConfigurator();
        showNotification('‚úÖ ' + configData.colorLabel + ' sofa added to cart!');
        
        // Update config summary
        document.getElementById('selected-color').textContent = configData.colorLabel;
        document.getElementById('selected-price').textContent = '$' + configData.price;
        document.getElementById('config-summary').style.display = 'block';
        
        // Update cart count
        updateCartCount();
      } else {
        throw new Error('Failed to add to cart');
      }
      
    } catch (error) {
      console.error('Cart error:', error);
      showNotification('‚ùå Failed to add to cart: ' + error.message);
    }
  }
  
  // Show notification
  function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; 
      background: ${message.includes('‚ùå') ? '#dc3545' : '#28a745'}; 
      color: white; padding: 16px 24px; border-radius: 8px; 
      z-index: 10000; font-weight: 600;
      transform: translateX(100%); transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, 4000);
  }
  
  // Update cart count
  function updateCartCount() {
    fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        const countEls = document.querySelectorAll('[data-cart-count], .cart-count');
        countEls.forEach(el => el.textContent = cart.item_count);
      });
  }
  
  // ESC key handler
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && configuratorOpen) closeConfigurator();
  });
  
})();
</script>

<!-- 
INSTALLATION INSTRUCTIONS FOR SECTIONS-BASED THEMES:

1. Open your Shopify Admin
2. Go to Online Store ‚Üí Themes ‚Üí Edit Code  
3. Open sections/main-product.liquid
4. Find the product form area (around line 110-120)
5. Add the code above AFTER the existing product form
6. Update the configuratorUrl to your deployed Vercel URL
7. Save the file

PRODUCT SETUP:
1. Make sure your product has variants with colors as option1
2. Add metafield: enable_3d_configurator = true
3. Test the integration!
-->
