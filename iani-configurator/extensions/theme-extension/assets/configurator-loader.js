(function(){'use strict';if(window.__ianiConfiguratorLoaded)return;window.__ianiConfiguratorLoaded=true;
var containers=document.querySelectorAll('[id^="iani-3d-configurator-"]');if(!containers.length)return;
containers.forEach(function(w){var c={blockId:w.dataset.blockId,productId:w.dataset.productId,productHandle:w.dataset.productHandle,variantId:w.dataset.variantId,productTitle:w.dataset.productTitle,productPrice:w.dataset.productPrice,shop:w.dataset.shop,currency:w.dataset.currency,moneyFormat:w.dataset.moneyFormat,configuratorUrl:w.dataset.configuratorUrl||'https://iani-configurator.vercel.app',displayMode:w.dataset.displayMode,autoLoad:w.dataset.autoLoad==='true',modelUrl:w.dataset.modelUrl||''};
var container=w.querySelector('.iani-configurator-container'),modalOverlay=w.querySelector('.iani-modal-overlay'),modalTrigger=w.querySelector('.iani-modal-trigger'),modalClose=w.querySelector('.iani-modal-close'),fullscreenTrigger=w.querySelector('.iani-fullscreen-trigger'),iframe=null;
function buildUrl(){var u=new URL(c.configuratorUrl);u.searchParams.set('product',c.productId);u.searchParams.set('variant',c.variantId);u.searchParams.set('shop',c.shop);u.searchParams.set('handle',c.productHandle);u.searchParams.set('currency',c.currency);u.searchParams.set('embedded','true');if(c.productPrice)u.searchParams.set('price',c.productPrice);if(c.modelUrl)u.searchParams.set('modelUrl',c.modelUrl);return u.toString()}
function createIframe(t){if(iframe)return iframe;iframe=document.createElement('iframe');iframe.className='iani-configurator-iframe';iframe.src=buildUrl();iframe.style.cssText='width:100%;height:100%;border:none;display:block;min-height:500px';iframe.allow='accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;fullscreen;camera;microphone';iframe.setAttribute('loading','eager');iframe.setAttribute('title','3D Configurator');iframe.onload=function(){var l=t.querySelector('.iani-loading');if(l)l.style.display='none'};t.appendChild(iframe);return iframe}
function handleMsg(e){try{if(e.origin!==(new URL(c.configuratorUrl)).origin)return;var d=e.data;if(!d||typeof d!=='object')return;
if(d.type==='IANI_TRYON_OPENED'&&modalClose)modalClose.style.display='none';
if(d.type==='IANI_TRYON_CLOSED'&&modalClose)modalClose.style.display='flex';
if(d.type==='IANI_READY'&&iframe&&iframe.contentWindow)iframe.contentWindow.postMessage({type:'IANI_INIT',payload:{productId:c.productId,variantId:c.variantId,productTitle:c.productTitle,productPrice:c.productPrice,shop:c.shop,currency:c.currency,moneyFormat:c.moneyFormat}},c.configuratorUrl);
if(d.type==='IANI_ADD_TO_CART'||d.type==='ADD_TO_CART'){var p=d.payload||d,props=p.configuration||p.properties||{},configId=p.configurationId||('config_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)),variantId=p.variantId||c.variantId;
props['_Configuration ID']=configId;
if(p.price){props['Configured Price']='$'+Number(p.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});try{var prices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');prices[configId]=Number(p.price);localStorage.setItem('iani_cart_prices',JSON.stringify(prices))}catch(x){}}
try{var items=JSON.parse(localStorage.getItem('iani_cart_items')||'{}');items[configId]={variantId:variantId,configuredPrice:p.price?Number(p.price):null,configuration:p.configuration||{},productId:p.productId||c.productId};localStorage.setItem('iani_cart_items',JSON.stringify(items))}catch(x){}
if(p.previewImage){try{var previews=JSON.parse(localStorage.getItem('iani_cart_previews')||'{}');previews[configId]=p.previewImage;localStorage.setItem('iani_cart_previews',JSON.stringify(previews))}catch(x){}}
fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:variantId,quantity:p.quantity||1,properties:props})}).then(function(r){return r.json()}).then(function(item){if(iframe&&iframe.contentWindow)iframe.contentWindow.postMessage({type:'IANI_CART_SUCCESS',payload:item},c.configuratorUrl);fetch('/cart.js').then(function(r){return r.json()}).then(function(cart){['.cart-count','.cart-count-bubble','[data-cart-count]'].forEach(function(s){var el=document.querySelector(s);if(el)el.textContent=cart.item_count})});if(p.redirectToCart!==false)setTimeout(function(){location.href='/cart'},500)}).catch(function(err){if(iframe&&iframe.contentWindow)iframe.contentWindow.postMessage({type:'IANI_CART_ERROR',payload:{message:err.message}},c.configuratorUrl);alert('Failed to add to cart.')})}
if(d.type==='IANI_CLOSE')closeModal()}catch(err){}}
function openModal(){if(!modalOverlay)return;if(modalOverlay.parentElement!==document.body)document.body.appendChild(modalOverlay);modalOverlay.style.display='flex';modalOverlay.classList.add('active');document.body.style.overflow='hidden';var mc=modalOverlay.querySelector('.iani-configurator-container');if(mc)createIframe(mc)}
function closeModal(){if(!modalOverlay)return;modalOverlay.style.display='none';modalOverlay.classList.remove('active');document.body.style.overflow=''}
window.addEventListener('message',handleMsg);
if(c.displayMode==='modal'){if(modalTrigger)modalTrigger.addEventListener('click',function(e){e.preventDefault();openModal()});if(modalClose)modalClose.addEventListener('click',function(e){e.preventDefault();closeModal()});if(modalOverlay)modalOverlay.addEventListener('click',function(e){if(e.target===modalOverlay)closeModal()});document.addEventListener('keydown',function(e){if(e.key==='Escape'&&modalOverlay&&modalOverlay.classList.contains('active'))closeModal()})}
if(c.displayMode==='inline'){if(c.autoLoad)createIframe(container);else{var btn=container.querySelector('.iani-modal-trigger');if(btn)btn.addEventListener('click',function(){btn.style.display='none';container.insertAdjacentHTML('beforeend','<div class="iani-loading"><div class="iani-loading-spinner"></div><span class="iani-loading-text">Loading...</span></div>');createIframe(container)})}}
if(fullscreenTrigger)fullscreenTrigger.addEventListener('click',function(){if(w.requestFullscreen)w.requestFullscreen();else if(w.webkitRequestFullscreen)w.webkitRequestFullscreen()})})})();
