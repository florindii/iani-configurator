{% comment %}
  Iani 3D Configurator App Block
  Renders an interactive 3D product configurator on product pages
  Allows customers to customize colors, materials, and options in real-time
{% endcomment %}

{% style %}
  .iani-configurator-wrapper {
    width: 100%;
    position: relative;
    background: {{ block.settings.background_color }};
    border-radius: {{ block.settings.border_radius }}px;
    overflow: hidden;
  }

  .iani-configurator-wrapper--inline {
    height: {{ block.settings.height }}px;
  }

  .iani-configurator-wrapper--modal {
    height: auto;
  }

  .iani-configurator-container {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .iani-configurator-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  .iani-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
    color: {{ block.settings.loading_text_color }};
    font-family: inherit;
  }

  .iani-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid {{ block.settings.loading_spinner_color | default: '#e0e0e0' }};
    border-top-color: {{ block.settings.accent_color | default: '#000000' }};
    border-radius: 50%;
    animation: iani-spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes iani-spin {
    to { transform: rotate(360deg); }
  }

  .iani-loading-text {
    font-size: 14px;
    opacity: 0.8;
  }

  .iani-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 300px;
    padding: 20px;
    text-align: center;
    color: #dc3545;
  }

  .iani-error-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .iani-error-message {
    font-size: 14px;
    margin-bottom: 16px;
  }

  .iani-retry-button {
    padding: 10px 20px;
    background: {{ block.settings.accent_color | default: '#000000' }};
    color: #ffffff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: opacity 0.2s;
  }

  .iani-retry-button:hover {
    opacity: 0.9;
  }

  /* Modal trigger button */
  .iani-modal-trigger {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: {{ block.settings.accent_color | default: '#000000' }};
    color: #ffffff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .iani-modal-trigger:hover {
    opacity: 0.9;
  }

  .iani-modal-trigger-icon {
    width: 20px;
    height: 20px;
  }

  /* Modal overlay */
  .iani-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2147483647;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .iani-modal-overlay.active {
    display: flex;
  }

  .iani-modal-content {
    width: 100%;
    max-width: 1200px;
    height: 90vh;
    max-height: 800px;
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }

  .iani-modal-content .iani-configurator-container {
    width: 100% !important;
    height: 100% !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
  }

  .iani-modal-content .iani-configurator-iframe,
  .iani-configurator-iframe {
    width: 100% !important;
    height: 100% !important;
    min-height: 500px !important;
    border: none !important;
    display: block !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
  }

  .iani-modal-content .iani-loading {
    display: none !important;
  }

  .iani-modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    color: #ffffff;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: background 0.2s;
  }

  .iani-modal-close:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  /* Fullscreen mode */
  .iani-fullscreen-trigger {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 4px;
    color: #ffffff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
    transition: background 0.2s;
  }

  .iani-fullscreen-trigger:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .iani-configurator-wrapper--inline {
      height: {{ block.settings.mobile_height }}px;
    }

    .iani-modal-content {
      height: 100vh;
      max-height: none;
      border-radius: 0;
    }
  }
{% endstyle %}

{% comment %}
  Get the first 3D model from product media (GLB/GLTF files)
{% endcomment %}
{% assign model_url = '' %}
{% for media in product.media %}
  {% if media.media_type == 'model' %}
    {% for source in media.sources %}
      {% if source.format == 'glb' %}
        {% assign model_url = source.url %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% if model_url == '' %}
      {% assign model_url = media.sources[0].url %}
    {% endif %}
    {% break %}
  {% endif %}
{% endfor %}

<div
  id="iani-3d-configurator-{{ block.id }}"
  class="iani-configurator-wrapper iani-configurator-wrapper--{{ block.settings.display_mode }}"
  data-block-id="{{ block.id }}"
  data-product-id="{{ product.id }}"
  data-product-handle="{{ product.handle }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-product-title="{{ product.title | escape }}"
  data-product-price="{{ product.price | money_without_currency }}"
  data-shop="{{ shop.permanent_domain }}"
  data-currency="{{ cart.currency.iso_code }}"
  data-money-format="{{ shop.money_format | escape }}"
  data-configurator-url="{{ block.settings.configurator_url }}"
  data-display-mode="{{ block.settings.display_mode }}"
  data-show-fullscreen="{{ block.settings.show_fullscreen_button }}"
  data-auto-load="{{ block.settings.auto_load }}"
  data-model-url="{{ model_url }}"
>
  {% if block.settings.display_mode == 'modal' %}
    <!-- Modal trigger button - this is what shows on the product page -->
    <button type="button" class="iani-modal-trigger" aria-label="{{ 'iani.configurator.open_configurator' | t }}">
      <svg class="iani-modal-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
      {{ block.settings.button_text | default: 'Customize in 3D' }}
    </button>

    <!-- Modal overlay - FIXED: positioned at body level with portal -->
    <div class="iani-modal-overlay" role="dialog" aria-modal="true" aria-label="{{ 'iani.configurator.modal_title' | t }}" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;background:rgba(0,0,0,0.9);z-index:2147483647;align-items:center;justify-content:center;padding:20px;">
      <div class="iani-modal-content" style="width:100%;max-width:1400px;height:90vh;max-height:900px;background:#ffffff;border-radius:12px;overflow:hidden;position:relative;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">
        <button type="button" class="iani-modal-close" aria-label="{{ 'iani.configurator.close' | t }}" style="position:absolute;top:16px;right:16px;width:44px;height:44px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:#ffffff;font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;transition:background 0.2s;">&times;</button>
        <div class="iani-configurator-container" style="width:100%;height:100%;position:relative;">
          <div class="iani-loading" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;">
            <div class="iani-loading-spinner"></div>
            <span class="iani-loading-text">{{ 'iani.configurator.loading' | t | default: 'Loading 3D Configurator...' }}</span>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Inline configurator -->
    <div class="iani-configurator-container">
      {% if block.settings.show_fullscreen_button %}
        <button type="button" class="iani-fullscreen-trigger" aria-label="{{ 'iani.configurator.fullscreen' | t }}">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
        </button>
      {% endif %}

      {% if block.settings.auto_load %}
        <div class="iani-loading">
          <div class="iani-loading-spinner"></div>
          <span class="iani-loading-text">{{ 'iani.configurator.loading' | t | default: 'Loading 3D Configurator...' }}</span>
        </div>
      {% else %}
        <button type="button" class="iani-modal-trigger" style="margin: auto;">
          <svg class="iani-modal-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          {{ 'iani.configurator.load_configurator' | t | default: 'Load 3D Configurator' }}
        </button>
      {% endif %}
    </div>
  {% endif %}
</div>

<script src="{{ 'configurator-loader.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "3D Product Configurator",
  "target": "section",
  "javascript": "configurator-loader.js",
  "stylesheet": "configurator.css",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Configurator Settings"
    },
    {
      "type": "text",
      "id": "configurator_url",
      "label": "Configurator URL",
      "info": "The URL where your 3D configurator is hosted",
      "default": "https://iani-configurator.vercel.app"
    },
    {
      "type": "select",
      "id": "display_mode",
      "label": "Display Mode",
      "options": [
        { "value": "inline", "label": "Inline (embedded on page)" },
        { "value": "modal", "label": "Modal (popup window)" }
      ],
      "default": "inline",
      "info": "How the configurator appears on the page"
    },
    {
      "type": "checkbox",
      "id": "auto_load",
      "label": "Auto-load configurator",
      "default": true,
      "info": "Load immediately or require user click"
    },
    {
      "type": "header",
      "content": "Dimensions"
    },
    {
      "type": "range",
      "id": "height",
      "label": "Height (desktop)",
      "min": 400,
      "max": 900,
      "step": 25,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_height",
      "label": "Height (mobile)",
      "min": 300,
      "max": 700,
      "step": 25,
      "default": 450,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f5f5f5"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#000000",
      "info": "Used for buttons and loading spinner"
    },
    {
      "type": "color",
      "id": "loading_text_color",
      "label": "Loading text color",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Controls"
    },
    {
      "type": "checkbox",
      "id": "show_fullscreen_button",
      "label": "Show fullscreen button",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text (modal mode)",
      "default": "Customize in 3D"
    },
    {
      "type": "header",
      "content": "Advanced"
    },
    {
      "type": "checkbox",
      "id": "debug_mode",
      "label": "Enable debug mode",
      "default": false,
      "info": "Shows additional console logs for troubleshooting"
    }
  ]
}
{% endschema %}
