{% comment %}
  Iani 3D Configurator - Cart Preview Handler
  Updates preview images and Estimated Total for configured items
{% endcomment %}

<!-- Iani Cart Preview Handler -->
<div id="iani-cart-preview-handler" style="display:none;" data-iani-version="1.26"></div>

<script>
(function(){
  'use strict';
  console.log('[Iani Cart] v1.26 loaded');

  function applyCartCustomizations(){
    const storedPreviews=JSON.parse(localStorage.getItem('iani_cart_previews')||'{}');
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');
    const priceKeys=Object.keys(storedPrices);
    const previewKeys=Object.keys(storedPreviews);

    console.log('[Iani Cart] Prices stored:',storedPrices);

    if(priceKeys.length===0)return;

    // Calculate total of ALL stored configured prices
    let totalConfiguredPrice=0;
    priceKeys.forEach(function(key){
      totalConfiguredPrice+=storedPrices[key];
      console.log('[Iani Cart] Adding price:',key,'=',storedPrices[key]);
    });

    console.log('[Iani Cart] Total configured price:',totalConfiguredPrice);

    // Apply preview images to Iani cart items
    const cartContainers=document.querySelectorAll('tr, [class*="cart-item"], .line-item');
    cartContainers.forEach(function(container){
      if(container.dataset.ianiPreviewDone)return;
      const text=container.textContent||'';
      if(!text.includes('Extra Colors'))return;

      container.dataset.ianiPreviewDone='true';
      const img=container.querySelector('img');
      if(img&&previewKeys.length>0&&!img.dataset.ianiPreview){
        // Find matching preview or use latest
        const configMatch=container.innerHTML.match(/config_\d+_[a-z0-9]+/i);
        let previewUrl=null;
        if(configMatch&&storedPreviews[configMatch[0]]){
          previewUrl=storedPreviews[configMatch[0]];
        }else{
          previewUrl=storedPreviews[previewKeys[previewKeys.length-1]];
        }
        if(previewUrl){
          img.src=previewUrl;
          img.style.border='2px solid #4CAF50';
          img.style.borderRadius='4px';
          img.dataset.ianiPreview='true';
        }
      }
    });

    // Update Estimated Total
    if(totalConfiguredPrice>0){
      updateEstimatedTotal(totalConfiguredPrice);
    }
  }

  function updateEstimatedTotal(total){
    if(document.body.dataset.ianiTotalDone)return;

    const formattedPrice='$'+total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    console.log('[Iani Cart] Formatted total:',formattedPrice);

    // Find the Estimated total element - it's usually near text "Estimated total"
    // In Dawn theme, it's in .totals with a span containing the price

    // Strategy: find all elements with "RSD" (the currency) that are NOT in cart item rows
    const allElements=document.querySelectorAll('.totals *, .cart__footer *, [class*="total"] *');
    let found=false;

    allElements.forEach(function(el){
      if(found)return;
      // Skip if inside a cart item row
      if(el.closest('tr[class*="cart"]')||el.closest('[class*="cart-item"]'))return;

      const text=el.textContent.trim();
      // Look for price pattern with RSD
      if(/^[\d,]+\.?\d*\s*RSD$/i.test(text)){
        console.log('[Iani Cart] Found total element:',text,el);
        el.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.9em;">'+text+'</span><br><span style="color:#4CAF50;font-weight:bold;font-size:1.1em;">'+formattedPrice+'</span>';
        found=true;
        document.body.dataset.ianiTotalDone='true';
      }
    });

    // Fallback: search entire page for "Estimated total" text and update nearby price
    if(!found){
      document.querySelectorAll('*').forEach(function(el){
        if(found)return;
        if(el.children.length>5)return;

        const text=el.textContent.toLowerCase();
        if(text==='estimated total'){
          // Found the label, look for sibling or parent's price
          const parent=el.parentElement;
          if(parent){
            const spans=parent.querySelectorAll('span');
            spans.forEach(function(span){
              if(found)return;
              const spanText=span.textContent.trim();
              if(/[\d,]+\.?\d*\s*RSD/i.test(spanText)){
                console.log('[Iani Cart] Found total via label:',spanText);
                span.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.9em;">'+spanText+'</span><br><span style="color:#4CAF50;font-weight:bold;">'+formattedPrice+'</span>';
                found=true;
                document.body.dataset.ianiTotalDone='true';
              }
            });
          }
        }
      });
    }

    if(!found){
      console.log('[Iani Cart] Could not find Estimated total element');
    }
  }

  // Run after page loads
  if(document.readyState==='complete'){
    applyCartCustomizations();
  }else{
    window.addEventListener('load',applyCartCustomizations);
  }
  setTimeout(applyCartCustomizations,800);
  setTimeout(applyCartCustomizations,2000);
})();
</script>

{% schema %}
{
  "name": "Iani Cart Previews",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "settings": []
}
{% endschema %}
