{% comment %}
  Iani 3D Configurator - Cart Preview Handler
  Add this block to the cart template to display custom 3D preview images and configured prices
{% endcomment %}

<!-- Iani Cart Preview Handler - This block enables custom 3D preview images and prices -->
<div id="iani-cart-preview-handler" style="display:none;" data-iani-version="1.23"></div>

<script>
(function(){
  'use strict';
  console.log('[Iani Cart] Cart preview script loaded v1.23');

  function applyCartCustomizations(){
    const storedPreviews=JSON.parse(localStorage.getItem('iani_cart_previews')||'{}');
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');
    const previewKeys=Object.keys(storedPreviews);
    const priceKeys=Object.keys(storedPrices);
    console.log('[Iani Cart] Stored previews:',previewKeys.length,'prices:',priceKeys.length);

    if(previewKeys.length===0&&priceKeys.length===0)return;

    // Calculate total configured price for all Iani items
    let totalConfiguredPrice=0;
    let ianiItemCount=0;

    // Find all cart item containers
    const images=document.querySelectorAll('.cart img, [class*="cart"] img, main img, table img');
    console.log('[Iani Cart] Found images:',images.length);

    images.forEach(function(img){
      if(img.dataset.ianiApplied)return;

      // Find the parent container that has the properties
      let container=img.closest('tr')||img.closest('[class*="cart-item"]')||img.closest('.cart__row')||img.closest('.line-item');
      if(!container){
        // Try going up a few levels
        let parent=img.parentElement;
        for(let i=0;i<5&&parent;i++){
          if(parent.tagName==='TR'||parent.className&&(parent.className.includes('cart')||parent.className.includes('line'))){
            container=parent;
            break;
          }
          parent=parent.parentElement;
        }
      }
      if(!container)return;

      const containerText=container.textContent||'';
      const containerHTML=container.innerHTML||'';

      // Check if this container has Iani configuration properties (including hidden ones with _)
      const hasIaniProps=containerText.includes('Extra Colors')||containerText.includes('_cushionColor')||containerText.includes('_configuration_id');

      if(!hasIaniProps)return;

      console.log('[Iani Cart] Found cart item with Iani properties');
      ianiItemCount++;

      // Apply preview image
      const latestPreviewKey=previewKeys[previewKeys.length-1];
      if(latestPreviewKey&&storedPreviews[latestPreviewKey]&&!img.dataset.ianiPreviewApplied){
        console.log('[Iani Cart] Applying preview image');
        img.src=storedPreviews[latestPreviewKey];
        img.style.objectFit='cover';
        img.style.backgroundColor='#f8f9fa';
        img.style.border='2px solid #4CAF50';
        img.style.borderRadius='4px';
        img.dataset.ianiPreviewApplied='true';
      }

      // Apply configured price - find and update price elements
      const latestPriceKey=priceKeys[priceKeys.length-1];
      if(latestPriceKey&&storedPrices[latestPriceKey]&&!container.dataset.ianiPriceApplied){
        const configuredPrice=storedPrices[latestPriceKey];
        console.log('[Iani Cart] Configured price:',configuredPrice);
        totalConfiguredPrice+=configuredPrice;

        // Find price elements in this container - look for money/price class elements
        const priceSelectors=[
          '.cart-item__price','.price','.money','[class*="price"]','[class*="Price"]',
          '.cart__price','td:last-child','.line-item__price','[data-cart-item-price]'
        ];

        priceSelectors.forEach(function(selector){
          const priceElements=container.querySelectorAll(selector);
          priceElements.forEach(function(el){
            // Skip if already processed or if it's a quantity/remove element
            if(el.dataset.ianiPriceReplaced)return;
            if(el.querySelector('input')||el.querySelector('button'))return;

            const text=el.textContent.trim();
            // Check if this looks like a price (contains currency symbol or number pattern)
            if(/[\$€£¥₹]|RSD|\d+[.,]\d{2}|\d+\s*(USD|EUR|RSD)/i.test(text)){
              console.log('[Iani Cart] Updating price element:',text,'->','$'+configuredPrice.toFixed(2));

              // Create styled price replacement
              const originalPrice=el.innerHTML;
              el.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.85em;">'+originalPrice+'</span> <span style="color:#4CAF50;font-weight:bold;">$'+configuredPrice.toFixed(2)+'</span>';
              el.dataset.ianiPriceReplaced='true';
            }
          });
        });

        container.dataset.ianiPriceApplied='true';
      }

      img.dataset.ianiApplied='true';
    });

    // Update the Estimated Total / Cart Total if we have Iani items
    if(ianiItemCount>0&&totalConfiguredPrice>0){
      updateCartTotal(totalConfiguredPrice);
    }
  }

  function updateCartTotal(configuredTotal){
    // Find cart total elements - various theme selectors
    const totalSelectors=[
      '.totals__subtotal-value','.cart__subtotal','.cart-subtotal__price',
      '[data-cart-subtotal]','[data-cart-total]','.cart__total-price',
      '.cart-total__price','.totals .money','.cart__footer .money',
      '[class*="total"] .money','[class*="subtotal"] .money',
      '.cart-drawer__subtotal','.mini-cart__subtotal'
    ];

    let totalUpdated=false;

    totalSelectors.forEach(function(selector){
      const totalElements=document.querySelectorAll(selector);
      totalElements.forEach(function(el){
        if(el.dataset.ianiTotalReplaced)return;

        const text=el.textContent.trim();
        // Check if this looks like a price
        if(/[\$€£¥₹]|RSD|\d+[.,]\d{2}|\d+\s*(USD|EUR|RSD)/i.test(text)){
          console.log('[Iani Cart] Updating cart total:',text,'->','$'+configuredTotal.toFixed(2));

          // Replace with configured total
          const originalTotal=el.innerHTML;
          el.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.85em;display:block;">'+originalTotal+'</span><span style="color:#4CAF50;font-weight:bold;">$'+configuredTotal.toFixed(2)+'</span>';
          el.dataset.ianiTotalReplaced='true';
          totalUpdated=true;
        }
      });
    });

    // Also try to find and update "Estimated total" text that appears near totals
    if(!totalUpdated){
      // Look for elements containing "Estimated" or "Total" near price elements
      const allElements=document.querySelectorAll('*');
      allElements.forEach(function(el){
        if(el.dataset.ianiTotalReplaced)return;
        if(el.children.length>3)return; // Skip containers with many children

        const text=el.textContent.toLowerCase();
        if((text.includes('estimated')||text.includes('subtotal')||text.includes('total'))&&
           !text.includes('shipping')&&!text.includes('tax')){
          // Find money element nearby
          const parent=el.parentElement;
          if(parent){
            const moneyEl=parent.querySelector('.money')||parent.querySelector('[class*="price"]');
            if(moneyEl&&!moneyEl.dataset.ianiTotalReplaced){
              const priceText=moneyEl.textContent.trim();
              if(/[\$€£¥₹]|RSD|\d+[.,]\d{2}/i.test(priceText)){
                console.log('[Iani Cart] Updating estimated total:',priceText,'->','$'+configuredTotal.toFixed(2));
                const originalTotal=moneyEl.innerHTML;
                moneyEl.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.85em;display:block;">'+originalTotal+'</span><span style="color:#4CAF50;font-weight:bold;">$'+configuredTotal.toFixed(2)+'</span>';
                moneyEl.dataset.ianiTotalReplaced='true';
              }
            }
          }
        }
      });
    }
  }

  // Run on page load and after delays for dynamic content
  if(document.readyState==='complete'){
    applyCartCustomizations();
  }else{
    window.addEventListener('load',applyCartCustomizations);
  }
  setTimeout(applyCartCustomizations,500);
  setTimeout(applyCartCustomizations,1500);
  setTimeout(applyCartCustomizations,3000);

  // Also watch for DOM changes (for AJAX carts)
  const observer=new MutationObserver(function(mutations){
    let shouldUpdate=false;
    mutations.forEach(function(m){
      if(m.addedNodes.length>0)shouldUpdate=true;
    });
    if(shouldUpdate){
      setTimeout(applyCartCustomizations,100);
    }
  });
  observer.observe(document.body,{childList:true,subtree:true});
})();
</script>

{% schema %}
{
  "name": "Iani Cart Previews",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "settings": []
}
{% endschema %}
