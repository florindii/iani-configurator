{% comment %}
  Iani 3D Configurator - Cart Preview Handler v2.3
  - Preview images for configured items
  - Estimated total update (with quantity change support)
  - Draft Order checkout for custom pricing
{% endcomment %}

<!-- Iani Cart Preview Handler -->
<div id="iani-cart-preview-handler"
     style="display:none;"
     data-iani-version="2.3"
     data-shop="{{ shop.permanent_domain }}"
     data-api-url="https://iani-configurator-1.onrender.com">
</div>

<script>
(function(){
  'use strict';
  console.log('[Iani Cart] v2.3 loaded');

  const handler=document.getElementById('iani-cart-preview-handler');
  const SHOP=handler?handler.dataset.shop:'';
  const API_URL=handler?handler.dataset.apiUrl:'https://iani-configurator-1.onrender.com';

  // Restore prices from cart properties if localStorage is empty
  async function restorePricesFromCart(){
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');
    if(Object.keys(storedPrices).length>0)return;

    try{
      const cartResponse=await fetch('/cart.js');
      const cart=await cartResponse.json();
      const restoredPrices={};
      const restoredItems={};

      cart.items.forEach(function(item){
        const props=item.properties||{};
        const configId=props['_Configuration ID']||props['Configuration ID'];
        const configuredPriceStr=props['Configured Price'];

        if(configId&&configuredPriceStr){
          const priceMatch=configuredPriceStr.match(/[\d,]+\.?\d*/);
          if(priceMatch){
            const price=parseFloat(priceMatch[0].replace(/,/g,''));
            if(!isNaN(price)&&price>0){
              restoredPrices[configId]=price;
              restoredItems[configId]={
                variantId:item.variant_id.toString(),
                configuredPrice:price,
                productId:item.product_id.toString()
              };
            }
          }
        }
      });

      if(Object.keys(restoredPrices).length>0){
        localStorage.setItem('iani_cart_prices',JSON.stringify(restoredPrices));
        localStorage.setItem('iani_cart_items',JSON.stringify(restoredItems));
        console.log('[Iani Cart] Restored',Object.keys(restoredPrices).length,'prices');
      }
    }catch(err){
      console.error('[Iani Cart] Error restoring prices:',err);
    }
  }

  // Apply preview images and hide Configuration ID
  function applyPreviewImages(){
    const storedPreviews=JSON.parse(localStorage.getItem('iani_cart_previews')||'{}');

    // Hide Configuration ID elements (only exact matches in leaf elements)
    document.querySelectorAll('dt, dd, span, p, li').forEach(function(el){
      if(el.dataset.ianiHidden)return;
      if(el.children.length>0)return;

      const text=(el.textContent||'').trim();

      if(text==='Configuration ID:'||text==='Configuration ID'){
        el.style.display='none';
        el.dataset.ianiHidden='true';
        return;
      }

      if(/^config_\d+_[a-z0-9]+$/i.test(text)){
        el.style.display='none';
        el.dataset.ianiHidden='true';
        return;
      }
    });

    // Apply preview images
    if(Object.keys(storedPreviews).length===0)return;

    document.querySelectorAll('*').forEach(function(el){
      if(el.children.length>3)return;
      const text=el.textContent||'';
      const match=text.match(/config_\d+_[a-z0-9]+/i);
      if(!match)return;

      const configId=match[0];
      if(!storedPreviews[configId])return;

      let container=el;
      while(container&&container!==document.body){
        const img=container.querySelector('img');
        if(img&&!img.dataset.ianiPreview){
          img.src=storedPreviews[configId];
          img.style.border='2px solid #4CAF50';
          img.style.borderRadius='4px';
          img.style.objectFit='cover';
          img.dataset.ianiPreview='true';
          return;
        }
        container=container.parentElement;
      }
    });
  }

  // Update the estimated total - can be called multiple times (on quantity change)
  async function updateEstimatedTotal(forceUpdate){
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');
    if(Object.keys(storedPrices).length===0)return;

    try{
      const cartResponse=await fetch('/cart.js');
      const cart=await cartResponse.json();

      let configuredTotal=0;
      let hasConfiguredItems=false;

      cart.items.forEach(function(item){
        const props=item.properties||{};
        const configId=props['_Configuration ID']||props['Configuration ID'];

        if(configId&&storedPrices[configId]){
          configuredTotal+=storedPrices[configId]*item.quantity;
          hasConfiguredItems=true;
        }else{
          configuredTotal+=item.final_line_price/100;
        }
      });

      if(!hasConfiguredItems)return;

      const formattedPrice='$'+configuredTotal.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
      console.log('[Iani Cart] Calculated total:',formattedPrice);

      // Find existing iani total element and update it, or create new one
      const existingTotal=document.querySelector('.iani-configured-total');
      if(existingTotal){
        existingTotal.textContent=formattedPrice;
        console.log('[Iani Cart] Updated existing total');
        return;
      }

      // Find the Shopify total element to enhance
      const allElements=document.querySelectorAll('*');
      for(const el of allElements){
        if(el.querySelector('.iani-configured-total'))continue;
        if(el.classList&&el.classList.contains('iani-configured-total'))continue;
        if(el.closest('tr[class*="cart"]')||el.closest('[class*="cart-item"]')||el.closest('.cart-item'))continue;

        const text=el.textContent.trim();
        if(/^[\d,]+\.?\d*\s*RSD$/i.test(text)){
          const parent=el.parentElement;
          if(parent&&(parent.textContent.toLowerCase().includes('total')||parent.className.toLowerCase().includes('total'))){
            el.innerHTML='<span class="iani-original-total" style="text-decoration:line-through;color:#999;font-size:0.9em;">'+text+'</span><br><span class="iani-configured-total" style="color:#4CAF50;font-weight:bold;font-size:1.1em;">'+formattedPrice+'</span>';
            console.log('[Iani Cart] Created new total display');
            return;
          }
        }
      }
    }catch(err){
      console.error('[Iani Cart] Error updating total:',err);
    }
  }

  // Intercept cart AJAX to recalculate on quantity change
  function interceptCartAjax(){
    const originalFetch=window.fetch;
    window.fetch=function(){
      const url=arguments[0];

      if(typeof url==='string'&&(url.includes('/cart/change')||url.includes('/cart/update'))){
        return originalFetch.apply(this,arguments).then(function(response){
          // Clone response so we can read it and still return it
          const clonedResponse=response.clone();

          // After cart update, recalculate total
          setTimeout(function(){
            console.log('[Iani Cart] Cart quantity changed, recalculating...');
            updateEstimatedTotal(true);
          },300);

          return response;
        });
      }

      return originalFetch.apply(this,arguments);
    };
    console.log('[Iani Cart] Cart AJAX interceptor installed');
  }

  // Setup checkout intercept for Draft Order
  function setupCheckoutIntercept(){
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');
    if(Object.keys(storedPrices).length===0)return;

    const checkoutSelectors=[
      'button[name="checkout"]',
      'input[name="checkout"]',
      'button[type="submit"][form*="cart"]',
      '.cart__checkout-button',
      '[class*="checkout-button"]'
    ];

    checkoutSelectors.forEach(function(selector){
      document.querySelectorAll(selector).forEach(function(el){
        if(el.dataset.ianiCheckoutBound)return;
        el.dataset.ianiCheckoutBound='true';

        el.addEventListener('click',function(e){
          e.preventDefault();
          e.stopPropagation();
          createDraftOrderAndCheckout();
        });
      });
    });

    document.querySelectorAll('form[action*="/cart"],form[action="/checkout"]').forEach(function(form){
      if(form.dataset.ianiFormBound)return;
      form.dataset.ianiFormBound='true';

      form.addEventListener('submit',function(e){
        if(form.action.includes('/checkout')||e.submitter?.name==='checkout'){
          e.preventDefault();
          createDraftOrderAndCheckout();
        }
      });
    });
  }

  // Create Draft Order and redirect to checkout
  async function createDraftOrderAndCheckout(){
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');

    showCheckoutLoading(true);

    try{
      const cartResponse=await fetch('/cart.js');
      const cart=await cartResponse.json();

      const lineItems=[];
      cart.items.forEach(function(item){
        const props=item.properties||{};
        const configId=props['_Configuration ID']||props['Configuration ID'];
        const configuredPrice=configId?storedPrices[configId]:null;

        const customAttributes={};
        Object.entries(props).forEach(function([key,value]){
          if(!key.startsWith('_')){
            customAttributes[key]=value;
          }
        });

        lineItems.push({
          variantId:item.variant_id,
          quantity:item.quantity,
          configuredPrice:configuredPrice||null,
          customAttributes:Object.keys(customAttributes).length>0?customAttributes:null
        });
      });

      const hasConfiguredPrices=lineItems.some(function(item){return item.configuredPrice;});
      if(!hasConfiguredPrices){
        clearIaniStorage();
        window.location.href='/checkout';
        return;
      }

      const response=await fetch(API_URL+'/api/draft-order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({shop:SHOP,lineItems:lineItems})
      });

      const result=await response.json();

      if(result.success&&result.checkoutUrl){
        localStorage.setItem('iani_active_draft_order',JSON.stringify({
          id:result.draftOrderId,
          url:result.checkoutUrl,
          createdAt:Date.now()
        }));
        window.location.href=result.checkoutUrl;
      }else{
        showCheckoutLoading(false);
        if(confirm('Could not apply custom pricing. Proceed with base prices?')){
          clearIaniStorage();
          window.location.href='/checkout';
        }
      }
    }catch(err){
      console.error('[Iani Cart] Checkout error:',err);
      showCheckoutLoading(false);
      if(confirm('Error processing. Proceed with base prices?')){
        clearIaniStorage();
        window.location.href='/checkout';
      }
    }
  }

  function showCheckoutLoading(show){
    let overlay=document.getElementById('iani-checkout-loading');
    if(show){
      if(!overlay){
        overlay=document.createElement('div');
        overlay.id='iani-checkout-loading';
        overlay.innerHTML='<div style="background:white;padding:30px 50px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-align:center;"><div style="width:40px;height:40px;border:4px solid #e0e0e0;border-top-color:#4CAF50;border-radius:50%;animation:iani-spin 1s linear infinite;margin:0 auto 15px;"></div><div style="font-size:16px;color:#333;">Creating your order...</div></div>';
        overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
        const style=document.createElement('style');
        style.textContent='@keyframes iani-spin{to{transform:rotate(360deg)}}';
        document.head.appendChild(style);
        document.body.appendChild(overlay);
      }
      overlay.style.display='flex';
    }else if(overlay){
      overlay.style.display='none';
    }
  }

  function clearIaniStorage(){
    localStorage.removeItem('iani_cart_previews');
    localStorage.removeItem('iani_cart_prices');
    localStorage.removeItem('iani_cart_items');
  }

  function checkActiveDraftOrder(){
    try{
      const activeDraft=JSON.parse(localStorage.getItem('iani_active_draft_order')||'null');
      if(!activeDraft||!activeDraft.url)return;

      const ageMs=Date.now()-(activeDraft.createdAt||0);
      if(ageMs>30*60*1000){
        localStorage.removeItem('iani_active_draft_order');
        return;
      }

      if(document.getElementById('iani-draft-order-banner'))return;
      const banner=document.createElement('div');
      banner.id='iani-draft-order-banner';
      banner.innerHTML='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;"><span>You have a pending checkout with custom pricing.</span><div style="display:flex;gap:10px;"><button id="iani-resume-checkout" style="background:#4CAF50;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;">Resume Checkout</button><button id="iani-dismiss-banner" style="background:transparent;color:#333;border:1px solid #ccc;padding:8px 16px;border-radius:4px;cursor:pointer;">Start Fresh</button></div></div>';
      banner.style.cssText='position:fixed;top:0;left:0;right:0;background:#fff3cd;color:#856404;padding:12px 20px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.1);font-size:14px;';
      document.body.appendChild(banner);

      document.getElementById('iani-resume-checkout').addEventListener('click',function(){
        window.location.href=activeDraft.url;
      });
      document.getElementById('iani-dismiss-banner').addEventListener('click',function(){
        banner.remove();
        localStorage.removeItem('iani_active_draft_order');
      });
    }catch(e){}
  }

  function checkOrderComplete(){
    const url=window.location.href.toLowerCase();
    if(url.includes('/thank_you')||url.includes('/orders/')){
      localStorage.removeItem('iani_cart_previews');
      localStorage.removeItem('iani_cart_prices');
      localStorage.removeItem('iani_cart_items');
      localStorage.removeItem('iani_active_draft_order');
    }
  }

  // Single initialization flag
  let initialized=false;

  async function init(){
    if(initialized)return;
    initialized=true;

    checkOrderComplete();
    await restorePricesFromCart();
    applyPreviewImages();
    await updateEstimatedTotal();
    setupCheckoutIntercept();
    checkActiveDraftOrder();
    interceptCartAjax();
  }

  if(document.readyState==='complete'){
    init();
  }else{
    window.addEventListener('load',init);
  }

  // Single delayed run for slow themes
  setTimeout(function(){
    if(!initialized)init();
  },1500);
})();
</script>

{% schema %}
{
  "name": "Iani Cart Previews",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "settings": []
}
{% endschema %}
