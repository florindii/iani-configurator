{% comment %}
  Iani 3D Configurator - Cart Preview Handler
  Updates preview images and line item TOTAL prices for configured items
{% endcomment %}

<!-- Iani Cart Preview Handler -->
<div id="iani-cart-preview-handler" style="display:none;" data-iani-version="1.29"></div>

<script>
(function(){
  'use strict';
  console.log('[Iani Cart] v1.29 loaded');

  function applyCartCustomizations(){
    const storedPreviews=JSON.parse(localStorage.getItem('iani_cart_previews')||'{}');
    const storedPrices=JSON.parse(localStorage.getItem('iani_cart_prices')||'{}');

    console.log('[Iani Cart] Stored Previews:',Object.keys(storedPreviews));
    console.log('[Iani Cart] Stored Prices:',storedPrices);

    // STEP 1: First, find ALL Iani cart items and their config IDs
    const cartContainers=document.querySelectorAll('tr, [class*="cart-item"], .line-item');
    const activeConfigIds=[];
    const ianiItems=[];

    cartContainers.forEach(function(container){
      const containerHTML=container.innerHTML||'';
      const containerText=container.textContent||'';

      // Check if this is an Iani item (has Extra Colors or Configured Price)
      if(!containerText.includes('Extra Colors')&&!containerText.includes('Configured Price'))return;

      // Find the config ID in this container
      const configMatch=containerHTML.match(/config_\d+_[a-z0-9]+/i);
      const configId=configMatch?configMatch[0]:null;

      if(configId){
        activeConfigIds.push(configId);
      }
      ianiItems.push({container,configId});
    });

    console.log('[Iani Cart] Active config IDs in cart:',activeConfigIds);

    // STEP 2: Clean up stale entries from localStorage (items no longer in cart)
    cleanupStaleEntries(storedPreviews,storedPrices,activeConfigIds);

    // STEP 3: Process each Iani item
    let totalConfiguredPrice=0;
    let usedPriceKeys=[];

    ianiItems.forEach(function(item){
      const container=item.container;
      const configId=item.configId;

      if(container.dataset.ianiDone)return;
      container.dataset.ianiDone='true';

      console.log('[Iani Cart] Processing item with config ID:',configId);

      // Apply preview image
      const img=container.querySelector('img');
      if(img&&!img.dataset.ianiPreview&&configId&&storedPreviews[configId]){
        img.src=storedPreviews[configId];
        img.style.border='2px solid #4CAF50';
        img.style.borderRadius='4px';
        img.style.objectFit='cover';
        img.dataset.ianiPreview='true';
      }

      // Get configured price - ONLY use price if config ID matches
      let configuredPrice=null;
      if(configId&&storedPrices[configId]&&!usedPriceKeys.includes(configId)){
        configuredPrice=storedPrices[configId];
        usedPriceKeys.push(configId);
        totalConfiguredPrice+=configuredPrice;
        updateLineItemPrice(container,configuredPrice);
      }
    });

    console.log('[Iani Cart] Total configured price:',totalConfiguredPrice);

    // STEP 4: Update Estimated Total at bottom
    if(totalConfiguredPrice>0){
      updateEstimatedTotal(totalConfiguredPrice);
    }
  }

  // Clean up localStorage entries for items no longer in cart
  function cleanupStaleEntries(previews,prices,activeIds){
    let previewsChanged=false;
    let pricesChanged=false;

    // Remove stale previews
    Object.keys(previews).forEach(function(key){
      if(!activeIds.includes(key)){
        console.log('[Iani Cart] Removing stale preview:',key);
        delete previews[key];
        previewsChanged=true;
      }
    });

    // Remove stale prices
    Object.keys(prices).forEach(function(key){
      if(!activeIds.includes(key)){
        console.log('[Iani Cart] Removing stale price:',key);
        delete prices[key];
        pricesChanged=true;
      }
    });

    // Save cleaned up data back to localStorage
    if(previewsChanged){
      localStorage.setItem('iani_cart_previews',JSON.stringify(previews));
    }
    if(pricesChanged){
      localStorage.setItem('iani_cart_prices',JSON.stringify(prices));
    }
  }

  function updateLineItemPrice(container,configuredPrice){
    // Find the TOTAL cell/column for this line item
    // Common selectors: last td, .cart-item__totals, [class*="total"], .price
    const formattedPrice='$'+configuredPrice.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

    // Try different selectors for the line item total
    const selectors=[
      'td:last-child',
      '.cart-item__totals',
      '[class*="line-item-total"]',
      '[class*="cart-item__total"]'
    ];

    let priceElement=null;
    for(const selector of selectors){
      const el=container.querySelector(selector);
      if(el&&/[\d,]+\.?\d*\s*RSD/i.test(el.textContent)){
        priceElement=el;
        break;
      }
    }

    // Fallback: find any element with RSD price pattern in right part of container
    if(!priceElement){
      const allElements=container.querySelectorAll('*');
      for(const el of allElements){
        if(el.children.length>2)continue;
        const text=el.textContent.trim();
        // Match price pattern like "10,000.00 RSD"
        if(/^[\d,]+\.?\d*\s*RSD$/i.test(text)&&!el.dataset.ianiPriceDone){
          // Check if this is likely the TOTAL column (not the unit price column)
          const rect=el.getBoundingClientRect();
          const containerRect=container.getBoundingClientRect();
          // If element is in the right half of container, it's likely the TOTAL
          if(rect.left>containerRect.left+containerRect.width*0.5){
            priceElement=el;
            break;
          }
        }
      }
    }

    if(priceElement&&!priceElement.dataset.ianiPriceDone){
      const originalText=priceElement.textContent.trim();
      console.log('[Iani Cart] Updating line item total from:',originalText,'to:',formattedPrice);
      priceElement.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.85em;display:block;">'+originalText+'</span><span style="color:#4CAF50;font-weight:bold;">'+formattedPrice+'</span>';
      priceElement.dataset.ianiPriceDone='true';
    }
  }

  function updateEstimatedTotal(total){
    if(document.body.dataset.ianiTotalDone)return;

    const formattedPrice='$'+total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    console.log('[Iani Cart] Updating estimated total to:',formattedPrice);

    // Find elements in totals/footer area with RSD price
    const allElements=document.querySelectorAll('.totals *, .cart__footer *, [class*="total"] *');
    let found=false;

    allElements.forEach(function(el){
      if(found)return;
      // Skip if inside a cart item row
      if(el.closest('tr[class*="cart"]')||el.closest('[class*="cart-item"]'))return;

      const text=el.textContent.trim();
      if(/^[\d,]+\.?\d*\s*RSD$/i.test(text)){
        console.log('[Iani Cart] Found total element:',text);
        el.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.9em;">'+text+'</span><br><span style="color:#4CAF50;font-weight:bold;font-size:1.1em;">'+formattedPrice+'</span>';
        found=true;
        document.body.dataset.ianiTotalDone='true';
      }
    });

    // Fallback: search for "Estimated total" label
    if(!found){
      document.querySelectorAll('*').forEach(function(el){
        if(found)return;
        if(el.children.length>5)return;
        const text=el.textContent.toLowerCase();
        if(text==='estimated total'){
          const parent=el.parentElement;
          if(parent){
            const spans=parent.querySelectorAll('span');
            spans.forEach(function(span){
              if(found)return;
              const spanText=span.textContent.trim();
              if(/[\d,]+\.?\d*\s*RSD/i.test(spanText)){
                span.innerHTML='<span style="text-decoration:line-through;color:#999;font-size:0.9em;">'+spanText+'</span><br><span style="color:#4CAF50;font-weight:bold;">'+formattedPrice+'</span>';
                found=true;
                document.body.dataset.ianiTotalDone='true';
              }
            });
          }
        }
      });
    }
  }

  // Clear localStorage on checkout (order completed, no need to keep data)
  function setupCheckoutCleanup(){
    // Find checkout buttons/forms
    const checkoutSelectors=[
      'button[name="checkout"]',
      'input[name="checkout"]',
      '[class*="checkout"]',
      'form[action*="/checkout"]'
    ];

    checkoutSelectors.forEach(function(selector){
      document.querySelectorAll(selector).forEach(function(el){
        if(el.dataset.ianiCheckoutBound)return;
        el.dataset.ianiCheckoutBound='true';

        el.addEventListener('click',function(){
          console.log('[Iani Cart] Checkout clicked - clearing localStorage');
          localStorage.removeItem('iani_cart_previews');
          localStorage.removeItem('iani_cart_prices');
        });
      });
    });
  }

  // Run after page loads
  if(document.readyState==='complete'){
    applyCartCustomizations();
    setupCheckoutCleanup();
  }else{
    window.addEventListener('load',function(){
      applyCartCustomizations();
      setupCheckoutCleanup();
    });
  }
  setTimeout(applyCartCustomizations,800);
  setTimeout(applyCartCustomizations,2000);
})();
</script>

{% schema %}
{
  "name": "Iani Cart Previews",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "settings": []
}
{% endschema %}
